// ---------- Generators & datasource ----------
generator client {
  provider = "prisma-client-js"
}
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ---------- Enums ----------
enum PaymentMethod {
  qris
  bank_transfer
}

enum LocalDeliveryStatus {
  in_progress
  on_the_way
  pending_payment
  paid
}

enum DeliveryStatus {
  not_yet_submit_to_kurasi
  submitted_to_Kurasi
  label_confirmed
  ready_to_send
  tracking_received
}

enum SaleChannel {
  Ebay
  Etsy
  Other
}

enum TaxReference {
  SST
  VAT
  GST
  Other
}

// ---------- Core people ----------
model Customer {
  id         String   @id @default(cuid())
  name       String
  phone      String   @unique  // E.164 format: "+6281234567890"
  shopeeName String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  orders     Order[]

  @@index([phone])
}

model Buyer {
  id            String   @id @default(uuid())
  buyerFullName String
  buyerAddress1 String
  buyerAddress2 String
  buyerCity     String
  buyerState    String
  buyerZip      String
  buyerCountry  String     // ISO-2
  buyerEmail    String @default("")
  buyerPhone    String     // E.164 format: "+4479449755416"

  srns   BuyerSRN[]
  orders Order[]

  @@unique([buyerCountry, buyerPhone])
  @@index([buyerEmail])
  @@index([buyerFullName, buyerCity])
  @@index([buyerPhone])
  @@index([buyerCountry])
}

model BuyerSRN {
  saleRecordNumber Int     @id
  buyerId          String
  buyer            Buyer   @relation(fields: [buyerId], references: [id], onDelete: Cascade)

  kurasiShipmentId String? @unique
  trackingNumber   String?
  trackingSlug     String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  orders Order[]   // reverse relation for orders.srn

  @@index([kurasiShipmentId])
  @@index([trackingNumber])
  @@index([trackingSlug])
  @@index([buyerId])
}

// ---------- Orders & package ----------
model Order {
  id       String   @id @default(cuid())
  placedAt DateTime
  notes    String?

  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)
  customerId String

  buyerId String
  buyer   Buyer    @relation(fields: [buyerId], references: [id], onDelete: Restrict)

  package   PackageDetail @relation(fields: [packageId], references: [id], onDelete: Cascade)
  packageId String        @unique

  // Prices kept for future usage; harmless if null
  quotedAmountMinor  Int?
  shippingPriceMinor Int?
  feeMinor           Int?    // Local handling fee (calculated from weight + country)
  currency           String?
  pricingSource      String?

  localStatus    LocalDeliveryStatus @default(in_progress)
  deliveryStatus DeliveryStatus      @default(not_yet_submit_to_kurasi)
  paymentMethod  PaymentMethod       @default(qris)

  // Optional sender reference (shop's order id)
  externalRef  String?

  // SRN link (unique: one SRN â†’ at most one order)
  srnId Int?      @unique
  srn   BuyerSRN? @relation(fields: [srnId], references: [saleRecordNumber])

  // Marketplace/tax meta (optional)
  saleChannel  SaleChannel?
  taxReference TaxReference?
  taxNumber    String?

  labelId           String?
  trackingLink      String?
  krsTrackingNumber String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([placedAt])
  @@index([localStatus, deliveryStatus])
  @@index([customerId])
  @@index([buyerId])
}

model PackageDetail {
  id                 String   @id @default(cuid())
  weightGrams        Int?
  totalValue         Decimal?
  packageDescription String?
  lengthCm           Decimal?
  widthCm            Decimal?
  heightCm           Decimal?
  volumetricGrams    Int?

  // CHANGED: use raw Kurasi code "EP|ES|EX|PP" (string)
  service            String

  currency           String?   // totalValue currency
  sku                String?
  hsCode             String?
  countryOfOrigin    String?

  // Express (EX) content item fields - optional, used when service=EX
  itemDescription    String?
  itemQty            String?
  itemUnitValue      String?
  itemUnitWeight     String?

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  order              Order?
}

// ---------- Kurasi Shipment Sync ----------
model KurasiShipment {
  kurasiShipmentId  String   @id @unique
  saleRecordNumber  String?
  flagId            String?  // Shipped, In Box, etc.
  
  // Recipient
  buyerFullName     String
  buyerCountry      String   // ISO-2
  buyerCity         String?
  buyerState        String?
  buyerZip          String?
  buyerPhone        String?
  
  // Shipping
  serviceName       String?  // PP, ES, EP, EX
  carrier           String?
  shippingFee       String?  // "104,000" format from Kurasi
  shippingFeeMinor  Int?     // Parsed numeric value
  chargeableWeight  Int?
  actualWeight      Int?
  localFeeMinor     Int?     // Calculated local handling fee
  
  // Tracking
  trackingNumber    String?
  awb               String?
  boxId             String?
  
  // Timestamps from Kurasi
  shipmentReceivedAt DateTime?
  labelCreatedAt     DateTime?
  shippedAt          DateTime?
  
  // Local
  syncedAt          DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([buyerCountry])
  @@index([serviceName])
  @@index([flagId])
  @@index([shippedAt])
  @@index([saleRecordNumber])
}
